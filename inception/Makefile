# Inception project Makefile
.PHONY: all build up down clean fclean re logs status fix-perms fix-scripts

all: fix-perms fix-scripts
	@echo "ğŸš€ Starting Inception project..."
	@cd srcs && docker-compose --env-file .env up --build

build:
	@echo "ğŸ”§ Building Docker images..."
	@cd srcs && docker-compose --env-file .env build

up: fix-perms fix-scripts
	@echo "ğŸš€ Launching containers..."
	@cd srcs && docker-compose --env-file .env up -d

down:
	@echo "ğŸ›‘ Stopping containers..."
	@cd srcs && docker-compose --env-file .env down

clean:
	@echo "ğŸ§¹ Cleaning Docker environment..."
	@docker stop $$(docker ps -qa) 2>/dev/null || true
	@docker rm $$(docker ps -qa) 2>/dev/null || true
	@docker rmi -f $$(docker images -qa) 2>/dev/null || true
	@docker volume rm $$(docker volume ls -q) 2>/dev/null || true
	@docker network rm $$(docker network ls -q) 2>/dev/null || true

fclean: clean
	@echo "ğŸ—‘ï¸ Removing volumes and data..."
	@sudo rm -rf /home/rkhakimu/data/mariadb/* /home/rkhakimu/data/wordpress/*
	@docker-compose -f srcs/docker-compose.yml down -v --remove-orphans

re: fclean all

logs:
	@echo "ğŸ“œ Displaying container logs..."
	@cd srcs && docker-compose --env-file .env logs

status:
	@echo "ğŸ“Š Checking container status..."
	@docker ps -a

fix-perms:
	@echo "ğŸ” Setting up volume permissions..."
	@sudo mkdir -p /home/rkhakimu/data/mariadb /home/rkhakimu/data/wordpress
	@sudo chown -R 999:999 /home/rkhakimu/data/mariadb
	@sudo chown -R 65534:65534 /home/rkhakimu/data/wordpress
	@sudo chmod -R 775 /home/rkhakimu/data/mariadb /home/rkhakimu/data/wordpress

fix-scripts:
	@echo "ğŸ”§ Setting executable permissions for scripts..."
	@chmod +x srcs/requirements/mariadb/tools/init.sh
	@chmod +x srcs/requirements/mariadb/healthcheck.sh
	@chmod +x srcs/requirements/nginx/tools/generate-certs.sh
	@chmod +x srcs/requirements/wordpress/tools/init.sh
